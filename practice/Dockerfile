FROM eclipse-temurin:11 as builder

COPY gradlew .
COPY gradle gradle
COPY build.gradle .
COPY settings.gradle .
COPY src src

RUN chmod +x ./gradlew
RUN ./gradlew clean bootJar
RUN ./gradlew bootJar

FROM eclipse-temurin:11

ARG ARG_DATASOURCE_URL
ARG ARG_DATASOURCE_USERNAME
ARG ARG_DATASOURCE_PASSWORD
ARG ARG_DDLAUTO
ARG ARG_DRIVECLASSNAME

ENV SPRING_JPA_PROPERTIES_HIBERNATE_FORMAT_SQL=true
ENV SPRING_JPA_HIBERNATE_DDL_AUTO=${ARG_DDLAUTO}
ENV SPRING_JPA_DEFER_DATASOURCE_INITIALIZATION=true
ENV SPRING_JPA_PROPERTIES_HIBERNATE_SHOW_SQL=false
ENV SPRING_DATASOURCE_DRIVERCLASSNAME=${ARG_DRIVECLASSNAME}

ENV SPRING_DATASOURCE_URL=${ARG_DATASOURCE_URL}
ENV SPRING_DATASOURCE_USERNAME=${ARG_DATASOURCE_USERNAME}
ENV SPRING_DATASOURCE_PASSWORD=${ARG_DATABASE_PASSWORD}

COPY --from=builder build/libs/*.jar app.jar

EXPOSE 8080

ENTRYPOINT ["java","-jar","/app.jar"]